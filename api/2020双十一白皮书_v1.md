# Toms 2020 双十一 白皮书

# I.流程-重要节点监控

## 一.订单正向链路

### ★.订单获取、创建

获取方式：hub推送队列，Toms消费队列直接创建

- 监听队列：CG_hub2toms_top_order_pro_*

- 所属服务治理消费分组： 生产-创单

- 创单性能脚本（by分钟）：

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') dd, COUNT(1)
    FROM t_td_sales_order a
    WHERE a.ERP_SHOP_CODE NOT IN (
                              11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701,
                              176700, 176702, 11500, 11494, 11493, 326725, 326726, 176707
        )
      AND a.CREATE_TIME >= '2020-11-1 00:00'
    GROUP BY dd
    ORDER BY dd DESC;
    ```

- 性能调优方案

    - 调整消费线程数量和副本数量

- 性能调优条件

    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 所有队列数据都有积压，且性能小于3.5W/分钟，调整线程数和副本数

- 代码入口：

    ```
    com.jumbo.tmalloms.manager.platform.TbCreateSoManagerImpl#saveHubTradeToOms
    ```

### ★.订单状态流转

定时任务抓数据发送RMQ，Toms消费MQ做状态流转

- 定时任务数据库配置（修改配置需要重启daemon）：

    ```
    SELECT * FROM t_sys_task_config c
    WHERE c.METHOD_NAME = 'transitionSoWf'
    ```

- 监听队列：CG_toms2toms_status_order_pro*

- 所属服务治理消费分组： 生产-过路由&状态流转&快递服务

- 流转性能脚本（by分钟）（修改）：

    ```
    SELECT DATE_FORMAT(
                   t.PROCESS_TIME,
                   '%Y-%c-%d %H:%i'
               ) dd,
           count(1)
    FROM t_td_so_wf_task t
    WHERE t.SHOP_ID NOT IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               )
      AND t.CREATE_TIME > '2020-11-1 00:00:00'
      AND t.PROCESS_STATUS = 10
    GROUP BY dd
    ORDER BY dd DESC;
    ```

- 性能调优方向：
    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 队列数据没有积压数据，且性能小于3W/分钟，修改定时任务
    - 所有队列数据都有积压，且性能小于3W/分钟，调整线程数和副本数

- 代码入口：

    ```
    com.jumbo.tmalloms.manager.workflow.TaskTransitionManagerImpl#transitionTaskNew(java.lang.String)
    ```

### ★.订单路由交互

#### 	1.发送订单数据至IM

定时任务加载数据发送rmq消费过路由

- 定时任务数据库配置（修改配置需要重启daemon）：

    ```
    SELECT * FROM t_sys_task_config c
    WHERE c.CLASS_NAME = 'com.jumbo.tmalloms.manager.route.OrderToRouteByDbManager'
    AND c.IS_AVAILABLE = 1
    ```

- 监听队列：CG_toms_to_toms_route_sales_*

- 所属服务治理消费分组： 生产-过路由&状态流转&快递服务

- 过路由性能脚本（by分钟）：

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H:%i') 过路由, COUNT(1)
    FROM t_send_wms a
    WHERE a.SHOP_ID not IN (
                        11498, 11497, 176700, 176702, 11500, 11494, 176704, 326725, 176705, 176706, 176707, 11496, 11499,
                        176703, 11495, 11493, 176701, 11501, 11502, 326726
        )
      AND a.CREATE_TIME >= '2020-12-10 00:00:00'
      AND a.MSG_TYPE = 'soRoute'
    GROUP BY 过路由
    ORDER BY 过路由 DESC;
    ```
    
- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 队列数据没有积压数据，且性能小于2W/分钟，修改定时任务
    - 所有队列数据都有积压，且性能小于2W/分钟，调整线程数和副本数

- 代码入口

    ```
    com.jumbo.tmalloms.manager.sales.task.SalesOrderRouteManagerImpl#convertAndSaveRouteStatus
    ```

#### 2.处理路由反馈

监听金桥RMQ队列，数据落库，定时任务处理路由反馈

- 监听队列：CG_hub2toms_order_split_result_pro

- 所属服务治理消费分组：生产-路由反馈&过仓反馈&在途反馈&库存同步

- 定时任务平台处理反馈:transfeSplitOrderMiddle

- 路由处理性能脚本（by分钟）

    ```
    SELECT DATE_FORMAT(t.PROCESS_TIME, '%Y-%c-%d %H:%i') 路由反馈, COUNT(*) 处理数量
    FROM t_split_order_head t
    WHERE t.input_time > '2020-12-10 00:00:00'
    AND t.PROCESS_STATUS = 10
    GROUP BY 路由反馈
    ORDER BY 路由反馈;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
- 调整消费线程数量和副本数量
  
- 性能调优条件

    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 所有队列数据都有积压，且性能小于2W/分钟，调整线程数和副本数
    - 队列数据没有积压数据，且性能小于2W/分钟，修改定时任务

- 代码入口：

    ```
    com.jumbo.tmalloms.manager.sales.impl.RouteReceiveResultManagerImpl#convertAndSaveRouteSalseNew
    ```

### ★.订单过快递服务

定时任务发送队列消费过快递服务

- 定时任务平台：orderToInterFace

- 监听队列：CG_toms2toms_wms_return_exchange_outbound_pro*

- 所属服务治理消费分组：生产-过路由&状态流转&快递服务

- 过快递服务性能脚本（by分钟）

    ```
    select DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H:%i' ) skxLF,COUNT(1) from t_send_wms a,t_td_sales_order o where a.SHOP_ID not in (11502, 11501, 11499, 176706, 176704, 176707, 11498, 11497, 176705,
                        176703, 11495, 11496, 176701, 176700, 176702, 11500, 11494, 11493, 326725, 326726)
     and a.CREATE_TIME >= '2020-10-21 00:00:00'
    and o.PLATFORM_ORDER_CODE_N = a.KEY_CODE
    and a.MSG_TYPE = 'DELIVERY'
    GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H:%i' ) 
    order BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H:%i' ) desc ;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于2500/分钟，修改定时任务
    - 所有队列数据都有积压，且性能小于2500/分钟，调整线程数和副本数

- 代码入口：

    ```
    toms:
    MQ:com.jumbo.tmalloms.manager.sales.task.HandleMiddleWmsManagerImpl#receiveRocketMqHandleMiddleWms

    qimen-adpter:
    com.baozun.ecp.ip.manager.qimen.hub4.LogisticsServiceManagerimpl#sendExpressService
    com.baozun.ecp.ip.manager.qimen.hub4.LogisticsServiceManagerimpl#getExpressNumber
    ```
    
    

### ★.订单过仓

定时任务发送队列消费过仓

- 定时任务数据库配置（修改配置需要重启daemon）：

    ```
    SELECT * FROM t_sys_task_config c
    WHERE c.METHOD_NAME = 'orderToWmsByDb'
    AND c.IS_AVAILABLE = 1
    ```

- 监听队列：CG_toms2toms_so_wms_order_pro*

- 所属服务治理消费分组：生产-过仓

- 过仓性能脚本

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') 过仓, COUNT(1) 数量
    FROM t_send_wms a
    WHERE a.SHOP_ID NOT IN (
                            11498, 11497, 176700, 176702, 11500, 11494, 176704, 326725, 176705, 176706, 176707, 11496,
                            11499,
                            176703, 11495, 11493, 176701, 11501, 11502, 326726
        )
      AND a.CREATE_TIME > '2020-12-10 00:00:00'
      AND a.MSG_TYPE = 'SO'
    GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i')
    ORDER BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 调整消费线程数量和副本数量
  
- 性能调优条件

    - 队列数据没有积压数据，且性能小于2W/分钟，修改定时任务
    - 所有队列数据都有积压，且性能小于2W/分钟，调整线程数和副本数

- 代码入口：

    - toms
    
    ```
    com.jumbo.tmalloms.manager.sales.task.CreateConfirmToWhCommandManagerImpl#syncMqSensWh
    ```
    
    - qimen-adpter
    
    ```
    com.baozun.ecp.ip.controller.BaseQimenReceiveController#doService
    ```
    
    

### ★.订单hold单过仓

- 定时任务平台：appointToWhByDb

- hold单处理性能脚本

    ```
    SELECT DATE_FORMAT(t.UPDATE_TIME, '%Y-%c-%d %H-%i') dd, COUNT(*)
    FROM t_td_so_appointment_to_wh_task t
    WHERE (t.SHOP_ID not IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               ) OR t.SHOP_ID IS NULL)
      AND t.process_status = 10
      AND t.CREATE_TIME > '2020-11-1 00:00:00'
    GROUP BY dd
    ORDER BY dd DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 性能调优条件

    - 性能小于1W/分钟，且有数据可以加载，修改定时任务


### ★.非直连订单过单pacs

定时任务抓取数据发送给pacs消费

- 定时任务平台：transferOrderToPacs

- 过仓性能脚本

    ```
    SELECT DATE_FORMAT(t.SYNC_TIME, '%Y-%c-%d %H:%i') 非直连过单, COUNT(*)
    FROM t_send_so_msg t
    WHERE t.SYNC_TIME > '2020-11-1 00:00:00'
      AND (t.SHOP_ID not IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               ) OR t.SHOP_ID IS NULL)
      AND t.sync_status = 1
    GROUP BY DATE_FORMAT(t.SYNC_TIME, '%Y-%c-%d %H:%i')
    ORDER BY DATE_FORMAT(t.SYNC_TIME, '%Y-%c-%d %H:%i') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 性能调优条件

    - 性能小于2000/分钟，且有数据可以加载，修改定时任务

### ★.WMS创单反馈

队列接收wsm反馈数据，直接流转至库房准备中，处理失败定时任务补偿

- 监听队列：CG_toms2toms_wms_qimen_confirm_pro

- 所属服务治理消费分组： 生产-路由反馈&过仓反馈&在途反馈&库存同步

- 定时任务平台：wmsConfirmOrderManagerPorxy

- 创单反馈性能脚本

    ```
    SELECT DATE_FORMAT(t.input_time, '%Y-%c-%d %H') wms创单反馈, COUNT(*)
    FROM t_wms_confirm_order t
    WHERE t.INPUT_TIME >= '2020-11-1 00:00:00'
      AND (t.SHOP_ID not IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               ) OR t.SHOP_ID IS NULL)
      AND t.process_status = 10
    GROUP BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H')
    ORDER BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 调整消费线程数量和副本数量
  
- 性能调优条件

    - 所有队列数据都有积压，且性能小于1.8W/分钟，调整线程数和副本数

- 代码入口：

    - toms
    
    ```
    com.jumbo.qimen.manager.QiMenProducerProductManagerImpl#receiveRocketWmsMqMsg
    com.jumbo.tmalloms.manager.sales.impl.WmsConfirmOrderManagerImpl#processWmsConfirmOrderNew
    ```
    
    - qimen-adpter
    
    ```
    hub3:
    http:
    com.baozun.ecp.ip.controller.Hub3ReceiveController#receiveWmsConfirm
    msgType:WmsConfirmOrder3
    MQ:
    com.baozun.ecp.ip.manager.qimen.send.outbound.wms3.OrderOutboundMqManagerImpl#receiveOrderOutboundConfirmMq
    
    hub4:
    MQ:
    com.baozun.ecp.ip.manager.qimen.send.orderstatus.confirm.SyncOrderStatusConsumer#syncOrderStatus2Qimen
    ```
    
    

### ★.WMS寻访式出库

仓库访问toms http接口，toms调用平台出库。

- 访问接口：/rest/qimen/doDefinedService

- msgtype: Hub4OutboundOrderIsAllowDelivery

- 询问出库性能调整：

    ```
    select DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H-%i' ) dd,COUNT(1) from t_send_hub_msg a where a.shop_id in (
    11502,11501,11499,176706,176704,11498,11497,176705,176703,11495,11496,176701,176700,176702,11500,11494,11493,326725,326726,176707
    ) and a.CREATE_TIME >= '2020-10-21 00:00:00' and MSG_TYPE = 'msg-02' and a.SYNC_STATUS in (4,5)
    GROUP BY dd 
    order BY dd desc;
    -- 4 失败 5 成功
    ```

- 异常分组查询错误

    ```
      SELECT
    	ERROR_CODE,ERROR_MESSAGE,COUNT(1)
    FROM
    	t_send_hub_msg t
    WHERE
    	t.MSG_TYPE = 'msg-02'
    AND t.CREATE_TIME >= '2020-11-1 10:30:00'
    AND t.error_code IS NOT NULL
    GROUP BY t.ERROR_CODE;
    ```

    

- hub日志监控（从hub适配器开始计算时间）

    - http://grafana-jq.baozun.com/d/-EYQHptMk/xun-wen-shi-chu-ku?orgId=1&refresh=1m

        

- 询问式出库日志查询奇门反馈总体时间（toms奇门适配器请求时间）：

    - isTimeout: 0    1s以内
    - isTimeout: 1    1s以上

    ```
    https://elk-jq.baozun.com/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-120m,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:outbound_order_is_allow_delivery),type:phrase),query:(match_phrase:(message:outbound_order_is_allow_delivery))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:app,negate:!f,params:(query:qimen-adapter-sync),type:phrase),query:(match_phrase:(app:qimen-adapter-sync))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:'isTimeout:%200'),type:phrase),query:(match_phrase:(message:'isTimeout:%200')))),index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',interval:auto,query:(language:lucene,query:''),sort:!(!('@timestamp',desc)))
    ```

    

- 询问式出库日志查询toms调用平台时间（toms调用平台请求时间）：

    - isTimeout350: 0    350ms以内
    - isTimeout350: 1    500s以上
    - isTimeout500: 0    350ms以内
    - isTimeout500: 1    500ms以上
```
    https://elk-jq.baozun.com/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-60m,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:topApiService.logisticsOfflineSendsync),type:phrase),query:(match_phrase:(message:topApiService.logisticsOfflineSendsync))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:'isTimeout350:1'),type:phrase),query:(match_phrase:(message:'isTimeout350:1'))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:'isTimeout500:1'),type:phrase),query:(match_phrase:(message:'isTimeout500:1'))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:app,negate:!f,params:(query:service-websync),type:phrase),query:(match_phrase:(app:service-websync)))),index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',interval:auto,query:(language:lucene,query:''),sort:!(!('@timestamp',desc)))
```


​    
- 定时任务调用出库查询toms调用平台时间（toms-deamon调用平台接口请求时间，可以作为再次开启询问出库的判断依据）：

    - isTimeout350: 0    350ms以内

    - isTimeout350: 1    500s以上

    - isTimeout500: 0    350ms以内

    - isTimeout500: 1    500ms以上

        ```
        https://elk-jq.baozun.com/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-120m,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:topApiService.logisticsOfflineSendDaemon),type:phrase),query:(match_phrase:(message:topApiService.logisticsOfflineSendDaemon))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:'isTimeout350:1'),type:phrase),query:(match_phrase:(message:'isTimeout350:1'))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:'isTimeout500:1'),type:phrase),query:(match_phrase:(message:'isTimeout500:1'))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:app,negate:!f,params:(query:service-websync),type:phrase),query:(match_phrase:(app:service-websync)))),index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',interval:auto,query:(language:lucene,query:''),sort:!(!('@timestamp',desc)))
        ```

    

    

- 询问式出库查询toms内部整体平台时间（toms内部处理时间）：

    - isTimeout800: 0    800ms以内

    - isTimeout900: 1    900s以上

    - isTimeout800: 0    800ms以内

    - isTimeout900: 1    900ms以上

        ```
        https://elk-jq.baozun.com/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-120m,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:QiMenAction.Hub4OutboundOrderIsAllowDelivery),type:phrase),query:(match_phrase:(message:QiMenAction.Hub4OutboundOrderIsAllowDelivery))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:'isTimeout350:1'),type:phrase),query:(match_phrase:(message:'isTimeout350:1'))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:message,negate:!f,params:(query:'isTimeout500:1'),type:phrase),query:(match_phrase:(message:'isTimeout500:1'))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',key:app,negate:!f,params:(query:service-websync),type:phrase),query:(match_phrase:(app:service-websync)))),index:'3f4a5f90-9b27-11ea-9f42-adf456cedc6b',interval:auto,query:(language:lucene,query:''),sort:!(!('@timestamp',desc)))
        ```

        

    通过elk 数据量可观察总体请求时间占比 超过1秒

    通过elk 数据量可观察请求平台时间占比 超过350ms

    

### ★.订单在途

监听mq生产在途数据中间表,定时任务跑订单在途

- 监听队列：CG_toms2toms_wms_qimen_out_bound_pro

- 所属服务治理消费分组： 生产-路由反馈&过仓反馈&在途反馈&库存同步

- 定时任务平台：wmsOrderStatusByDbManager

- 订单在途性能脚本：

    ```
    SELECT DATE_FORMAT(t.input_time, '%Y-%c-%d %H:%i') 在途反馈, COUNT(*)
    FROM t_wms_order_status t
    WHERE t.INPUT_TIME > '2020-11-1 00:00:00'
      AND (t.SHOP_ID not IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               ) OR t.SHOP_ID IS NULL)
      AND t.process_status = 10
    GROUP BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H:%i')
    ORDER BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H:%i') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于3000/分钟，定时任务有数据可加载，修改定时任务
    - 所有队列数据都有积压，且性能小于3000/分钟，调整线程数和副本数

- 代码入口：

    ```
    Toms MQ接收代码:
    com.jumbo.tmalloms.manager.sales.impl.WmsOrderStatusManagerImpl#convertAndSaveWmsOrderStatus(java.lang.Long, java.lang.String)
    com.jumbo.qimen.manager.QiMenProducerProductManagerImpl#receiveRocketWmsMqMsg
    com.jumbo.tmalloms.manager.sales.impl.WmsOutOrderFeedbackManagerImpl#convertAndSaveWmsOutOrderStatusNew
    
    
    奇门适配器接收代码:
    hub4:
    com.baozun.ecp.ip.manager.qimen.send.inbound.wms4.confirm.OutBoundConfirmMessageConsumer#receiveMqWms4OutBoundConfirm
    hub3:
    
    ```



### ★.非直连订单指令流转

定时任务触发数据处理

- 定时任务数据库配置（修改配置需要重启daemon）：

    ```
    SELECT * FROM t_sys_task_config c
    
    WHERE c.CLASS_NAME LIKE '%SoMsgHandleByDbManager%'
    ```

- 流转性能脚本

    ```
    select DATE_FORMAT(a.BZ_OPER_TIME, '%Y-%c-%d %H-%i' ) dd,COUNT(1) from t_receive_pacs_mq_msg_line a where a.SHOP_ID not in (
    11502,11501,11499,176706,176704,11498,11497,176705,176703,11495,11496,176701,176700,176702,11500,11494,11493,326725,326726,176707
    ) and a.CREATE_TIME >= '2020-11-1 00:00:00' and a.status = 1 and MSG_TYPE in ('O1-1', 'R1-1', 'F1-1')
    GROUP BY dd 
    order BY dd desc;
    -- msg_type O1-1 订单
    -- OP_TYPE : 1009 1009指令处理（pac已发送订单给wms）
    -- OP_TYPE : 1003、1004指令处理（1003：过仓失败指令；1004：wms库房准备中指令）
    -- OP_TYPE : 1006指令处理（在途指令）
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 性能调优条件

    - 队列数据没有积压数据，且性能小于3000/分钟，定时任务有数据可加载，修改定时任务

### ★.订单同步平台发货

定时任务加载数据直接调用平台接口

- 定时任务数据库配置（修改配置需要重启daemon）：

    ```
    SELECT * FROM t_sys_task_config c
    WHERE c.METHOD_NAME = 'logisticsOfflineSend'
    AND c.IS_AVAILABLE = 1
    ```

- 调用平台性能脚本

    ```
    select DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H-%i' ) dd,COUNT(1) from t_send_hub_msg a where a.shop_id in (
    11502,11501,11499,176706,176704,11498,11497,176705,176703,11495,11496,176701,176700,176702,11500,11494,11493,326725,326726,176707
    ) and a.CREATE_TIME >= '2020-10-21 00:00:00' and MSG_TYPE = 'msg-02' and a.SYNC_STATUS  = 1
    GROUP BY dd 
    order BY dd desc;
    ```

- 性能调优方向：	

    - 定时任务参数，频率调整



### ★.完结订单同步pacs

定时任务加载数据发送mq，pacs消费

- 定时任务平台：autoFinalOrderPacManager

- 监听队列：CG_toms2pac_so_final_O2_10_pro

- 同步pacs性能脚本

    ```
    select DATE_FORMAT(a.INPUT_TIME, '%Y-%c-%d %H-%i' ) dd,COUNT(1) from t_td_tally_order_to_pacs a where a.SHOP_ID not in (
    11502,11501,11499,176706,176704,11498,11497,176705,176703,11495,11496,176701,176700,176702,11500,11494,11493,326725,326726,176707
    ) and a.INPUT_TIME >= '2020-10-21 00:00:00' 
    and a.PROCESS_STATUS = 10
    GROUP BY dd 
    order BY dd desc;
    ```

- 性能调优方向：	
  
    - 定时任务参数，频率调整
    
- 性能调优条件

    - 队列数据没有积压数据，且性能小于3000/分钟，定时任务有数据可加载，修改定时任务

## 二.预售订单处理

### ★.预售订单刷尾款

消费hub的平台订单状态更新消息，解析保存到t_so_step_payment_log，并尝试刷尾款。第一次刷尾款失败的后续由定时任务加载数据发送重试队列进行重试。

- 监听队列：CG_hub2toms_order_update_pro

- 所属服务治理消费分组：预售刷尾款&通知发货

- 定时任务平台：stepOrderPaymentManager

- 监听队列：CG_toms2toms_stepOrder_refreshRetry_pro（重试队列）

- 所属服务治理消费分组： 预售刷尾款&通知发货

- 预售刷尾款性能：

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H') 刷尾款, COUNT(1)
    FROM t_so_step_payment_log a
    WHERE a.SHOP_ID NOT IN (
                        11498, 11497, 176700, 176702, 11500, 11494, 176704, 326725, 176705, 176706, 176707, 11496, 11499,
                        176703, 11495, 11493, 176701, 11501, 11502, 326726
        )
      AND a.CREATE_TIME >= '2020-11-1 00:00:00'
      AND a.CREATE_TIME <= '2020-11-1 05:00:00'
      AND a.PROCESS_STATUS = 10
    GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H')
    ORDER BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 性能调优条件

    - 队列数据没有积压数据，且性能小于1.4W/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于1.4W/分钟，调整线程数和副本数

- 调整消费线程数量和副本数量
  
- 代码入口

    ```
    com.jumbo.tmalloms.manager.mq.hub2toms.TaoBaoTradeUpdateServiceImpl#saveTradeUpdateToOMSMq
    ```

    ```
    com.jumbo.tmalloms.manager.sales.task.StepOrderRefreshRetryManagerImpl#refreshRetry
    ```

### ★.预包订单通知仓库发货

预包订单，且未取消状态，直连订单由定时任务加载数据发送队列消费调用hub实时接口

非直连定时任务插入中间表数据

- 定时任务平台：stepOrderPay2WhManager

- 监听队列：CG_toms2toms_step_order_pay_pro*

- 所属服务治理消费分组：预售刷尾款&通知发货

- 通知仓库发货性能

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H') 刷尾款, COUNT(1)
    FROM t_so_step_wh_queue a
    WHERE a.SHOP_ID NOT IN (
                        11498, 11497, 176700, 176702, 11500, 11494, 176704, 326725, 176705, 176706, 176707, 11496, 11499,
                        176703, 11495, 11493, 176701, 11501, 11502, 326726
        )
      AND a.CREATE_TIME >= '2020-11-1 00:00:00'
      AND a.CREATE_TIME <= '2020-11-1 05:00:00'
      AND a.PROCESS_STATUS = 10
    GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H')
    ORDER BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H') DESC;
    ```

- 预包过仓是否积压

    ```
    SELECT
            count(1)
    FROM
            t_so_step_wh_queue s
    LEFT JOIN t_td_sales_order t ON t.id = s.SO_ID
    WHERE
            t.IS_DIRECT_WMS_ORDER in(1,3)
    AND s.CREATE_TIME > '2020-11-01'
    AND s.PROCESS_STATUS IN (0, 2);
    ```

    

- by仓储系统统计已刷尾款且通知仓库出库的，wms3，wms4

    ```
    SELECT
        count(1)
    FROM
        t_so_step_wh_queue s
    LEFT JOIN t_td_sales_order t ON t.id = s.SO_ID
    WHERE
        t.IS_DIRECT_WMS_ORDER = 1
    AND s.CREATE_TIME >= '2020-11-01 00:00:00'
    AND s.id > 81903001
    AND s.PROCESS_STATUS = 10
    
    -- IS_DIRECT_WMS_ORDER = 1
    ```

    

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 性能调优条件

    - 队列数据没有积压数据，且性能小于7000/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于7000/分钟，调整线程数和副本数

- 调整消费线程数量和副本数量
  
- 代码入口

    ```
    com.jumbo.tmalloms.manager.sales.task.StepOrderRefreshPaymentManagerImpl#stepOrderPay2Wh
    ```

### ★.非直连尾款通知pac同步

定时任务加载数据发送队列，pacs消费获取

- 发送定时任务平台：mqMsgManagerProxy

- 发送性能

    ```
    select DATE_FORMAT(spmm.SYNC_TIME, '%Y-%c-%d %H%i') dd, COUNT(1)
    from t_send_pacs_mq_msg spmm
    where spmm.shop_id NOT IN (
                               11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701,
                               176700, 176702, 11500, 11494, 11493, 326725, 326726, 176707
        )
      AND spmm.SYNC_TIME >= '2020-10-21 00:00'
    AND (spmm.SYNC_STATUS = 1 or spmm.SYNC_STATUS = 4)
    AND spmm.MSG_TYPE = 'O2-15'
    GROUP BY dd
    ORDER BY dd DESC;
    ```

    

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 性能调优条件

    - 队列数据没有积压数据，且性能小于7000/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于7000/分钟，调整线程数和副本数

### ★.4号预售订单尾款指令和取消指令接入情况监控（付尾款结束后）

如果根据脚本查询出数据，说明指令未接入，或者订单未取消，需要核实。

```
SELECT` `COUNT``(*) ``from` `t_td_sales_order t ``where` `t.CREATE_TIME > ``'2020-10-21'` `and` `t.SPECIAL_TYPE ``in` `(11,12) ``and` `t.FINANCE_STATUS = 2 ``and``t.ORDER_STATUS ``not` `in` `(10,0);
```

## 三.订单逆向链路-商城取消

### ★.退款指令数据接入

  通过消费hub推送的数据的队列接入退款指令

- 监听队列:MQ_hub2toms_top_refund_order_pro  CG_hub2toms_refund_order_pro

- 所属服务治理消费分组：  生产-自动化售后

- 接收性能监控

    ```
    SELECT DATE_FORMAT(
                   t.UPDATE_TIME,
                   '%Y-%c-%d %H:%i'
               ) dd,
           count(1)
    FROM t_tb_automated_after_sale t
    WHERE t.SHOP_ID NOT IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               )
      AND t.CREATE_TIME > '2020-10-22 00:00:00'
    GROUP BY dd
    ORDER BY dd DESC;
    ```

- 性能调优方向：

    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 所有队列数据都有积压，且性能小于2500/分钟，调整线程数和副本数

- 代码入口:

    ```
    com.jumbo.tmalloms.manager.huboms.ReceiveRocketMqMsgManagerImpl#receiveRocketMqHubRefundOrder 
    com.jumbo.taobao.manager.TopRefundManagerImpl#transferTbRefundMq
    ```

### ★.退款数据解析

  通过定时任务解析退款指令用来做退货还是取消处理:

- 定时任务平台：automatedAfterSaleTaskManager

- 解析性能监控：

    ```
    SELECT DATE_FORMAT(
                   t.UPDATE_TIME,
                   '%Y-%c-%d %H:%i'
               ) dd,
           count(1)
    FROM t_tb_automated_after_sale t
    WHERE t.SHOP_ID NOT IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               )
      AND t.CREATE_TIME > '2020-06-16 00:00:00'
      AND t.PROCESS_STATUS = 10
    GROUP BY dd
    ORDER BY dd DESC;
    ```

- 性能调优方向：
  
    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 定时任务参数，频率调整
    
- 性能调优条件

    - 队列数据没有积压数据，且性能小于2500/分钟，有数据可以加载，修改定时任务

### ★.执行取消订单数据

定时任务发送取消数据至mq，执行取消

- 定时任务平台配置：agCancelDeliveryToMqTaskManager

- 监听队列：CG_toms2toms_ag_cancel_refund_pro*

- 所属服务治理消费分组：  生产-自动化售后

- 取消能脚本

    ```
    SELECT
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            ) 处理效率,
            COUNT(1)
    FROM
            t_ag_ship_cancel_detail t
    WHERE
            t.CREATE_TIME >= '2020-6-16 00:00:00'
    AND t.`STATUS` = 10
    GROUP BY
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            )
    ORDER BY
    DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            );
    ```

- 取消积压情况

    ```
    SELECT COUNT(1) FROM t_ag_ship_cancel_detail t
    WHERE t.CREATE_TIME >= '2020-11-1 00:00:00' 
    AND t.`STATUS` != 10;
    ```

    

- 预估多久可以处理完成（根据处理效率判断）

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 队列数据没有积压数据，且性能小于2500/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于2500/分钟，调整线程数和副本数

- 代码入口:

    ```
    1. com.jumbo.tmalloms.manager.huboms.ReceiveRocketMqMsgManagerImpl#cancelAndRefund
    2.com.jumbo.tmalloms.manager.refund.AutoCancelOrderAndCreateRefundManagerImpl#executeCancelAndRefund
    ```

    


### ★.创建退款单

定时任务发送创建退款单数据至MQ，消费队列创建退款单

- 定时任务平台配置： createRefundTaskManage

- 监听队列：CG_toms2toms_create_refund_pro*

- 所属服务治理消费分组：  生产-自动化售后

- 创建退款性能监控

    ```
    SELECT
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            ) 处理效率,
            COUNT(1)
    FROM
            t_td_create_refund_task t
    WHERE
            t.UPDATE_TIME >= '2020-06-16 10:00:00'
    AND (t.`STATUS` in (10) ) 
     AND t.SHOP_ID not in (176704,176707,176701,176700,176702)
    GROUP BY
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            )
    ORDER BY
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            ) desc;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
- 调整消费线程数量和副本数量
  
- 性能调优条件

    - 数据库性能未出现瓶颈（cpu不高，且没有锁）
    - 队列数据没有积压数据，且性能小于2500/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于2500/分钟，调整线程数和副本数

- 代码入口:

    ```
    com.jumbo.tmalloms.manager.huboms.ReceiveRocketMqMsgManagerImpl#receiveCreateRefund
    com.jumbo.tmalloms.manager.refund.CreateRefundConsumerManagerImpl#createRefund
    ```



## 四.退款

### ★.退款指令解析

通过定时任务解析退款指令

- 定时任务平台：processTbRefundManager

- 解析性能

  ```
  SELECT
  	DATE_FORMAT(
  		t.CREATE_TIME,
  		'%Y-%c-%d'
  	) 处理效率,
  	COUNT(1)
  FROM
  	 t_td_refund_direct t
  WHERE
  	t.CREATE_TIME >= '2020-11-1 00:00:00'
   GROUP BY
  	DATE_FORMAT(
  		t.CREATE_TIME,
  		'%Y-%c-%d'
  	);
  ```

- 性能调优方向：

  - 定时任务参数，频率调整
  
- 性能调优条件

    - 队列数据没有积压数据，且性能小于2500/分钟，有数据可以加载，修改定时任务

### ★.退款指令绑定

定时任务加载新建退款单进行指令绑定

- 定时任务平台：refundDirectsBindingManager

- 绑定性能(基于发送时间查询，有延迟)

  ```
  SELECT DATE_FORMAT(a.sync_to_pacs_time, '%Y-%c-%d %H%i') dd, COUNT(1)
  FROM t_td_rf_autotask_info a
  WHERE a.shop_id NOT IN (
                            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701,
                            176700, 176702, 11500, 11494, 11493, 326725, 326726, 176707
      )
    AND a.sync_to_pacs_time >= '2020-01-21 00:00'
  GROUP BY dd
  ORDER BY dd DESC;
  ```

- 性能调优方向：

  - 定时任务参数，频率调整
  
- 性能调优条件

    - 队列数据没有积压数据，且性能小于2500/分钟，有数据可以加载，修改定时任务

### ★.退款同步至pacs

定时任务组装数据生成F2-1至中间表,再由定时任务抓取数据发送至pacs消费

- 组装定时任务平台：rfToPacManager

- 组装性能

  ```
  select DATE_FORMAT(spmm.CREATE_TIME, '%Y-%c-%d %H%i') dd, COUNT(1)
  from t_send_pacs_mq_msg spmm
  where spmm.shop_id NOT IN (
                             11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701,
                             176700, 176702, 11500, 11494, 11493, 326725, 326726, 176707
      )
    AND spmm.CREATE_TIME >= '2020-11-1 00:00'
    AND spmm.MSG_TYPE = 'F2-1'
  GROUP BY dd
  ORDER BY dd DESC;
  ```

- 性能调优方向：

  - 定时任务参数，频率调整
  
- 性能调优条件

    - 队列数据没有积压数据，且性能小于2500/分钟，有数据可以加载，修改定时任务





- 发送定时任务平台：method：mqMsgManagerProxy class：MqMsgManagerProxyImpl

- 发送性能

  ```
  select DATE_FORMAT(spmm.SYNC_TIME, '%Y-%c-%d %H%i') dd, COUNT(1)
  from t_send_pacs_mq_msg spmm
  where spmm.shop_id NOT IN (
                             11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701,
                             176700, 176702, 11500, 11494, 11493, 326725, 326726, 176707
      )
    AND spmm.SYNC_TIME >= '2020-11-1 00:00'
  AND spmm.SYNC_STATUS = 4
  AND spmm.MSG_TYPE = 'F2-1'
  GROUP BY dd
  ORDER BY dd DESC;
  ```

  

- 性能调优方向：

  - 定时任务参数，频率调整

- 性能调优条件

    - 队列数据没有积压数据，且性能小于2500/分钟，有数据可以加载，修改定时任务

    

    

### ★.退款单流转

通过消费队列(来自pacs),落中间表,定时任务处理流转指令

- 监听队列：CG_pacs2tmalloms_F1-1_queue_pro

- 所属服务治理消费分组： 生产-退款&PAC交互&其他

- 定时任务平台method：handleRf,handleSoMsg

- handleSoMsg

- 处理性能脚本

  ```
  SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H') 指令流转, COUNT(1)
  FROM t_receive_pacs_mq_msg_line a
  WHERE a.SHOP_ID NOT IN (
                      11498, 11497, 176700, 176702, 11500, 11494, 176704, 326725, 176705, 176706, 176707, 11496, 11499,
                      176703, 11495, 11493, 176701, 11501, 11502, 326726
      )
    AND a.CREATE_TIME >= '2020-11-1 00:00:00'
    AND a.CREATE_TIME <= '2020-11-1 05:00:00'
    AND a.`STATUS` = 1
  AND a.MSG_TYPE = 'F1-1'
  GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H')
  ORDER BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H') DESC;
  ```

- 性能调优方向：

  - 定时任务参数，频率调整
  
- 调整消费线程数量和副本数量
  
- 性能调优条件

    - 队列数据没有积压数据，且性能小于1000/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于1000/分钟，调整线程数和副本数

- 代码入口：

  ```
  com.jumbo.tmalloms.manager.pacsoms.ReceiveMqMsgManagerImpl#receiveMqMsg
  ```



## 五.自动退款

#### ★.接收pacs数据调用AG退款

通过消费pacs推送至队列接入待财务执行的退款单数据，落表t_ag_pacs_refund_oms

然后定时任务调用AG退款

- 监听队列：CG_pacs2toms_agRefund_pro*

- 所属服务治理消费分组：  生产-自动化售后

- 定时任务平台：callTopToRefund

- 同步平台效率性能：

    ```
    SELECT
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            ) 处理效率,
            COUNT(1)
    FROM
            t_ag_pacs_refund_oms t
    WHERE
            t.CREATE_TIME >= '2020-11-1 00:00:00'
    AND t.`STATUS` = 1
    GROUP BY
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            )
    ORDER BY
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            ) desc;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
- 调整消费线程数量和副本数量
  
- 性能调优条件

    - 队列数据没有积压数据，且性能小于2000/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于2000/分钟，调整线程数和副本数





####  ★.通知pacs完成退款

接收数据参考★.退款数据解析落表t_ag_refund_notify_pacs

定时任务发送退款成功指令至pacs

- 定时任务平台：AutoRefundNotifyToPacsManager

- 同步pacs效率性能：

    ```
    SELECT
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            ) 处理效率,
            COUNT(1)
    FROM
            t_ag_refund_notify_pacs t
    WHERE
            t.CREATE_TIME >= '2020-11-1 00:00:00'
    AND t.`STATUS` = 5
    GROUP BY
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            )
    ORDER BY
            DATE_FORMAT(
                    t.UPDATE_TIME,
                    '%Y-%c-%d %H:%i'
            ) desc;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    
- 性能调优条件

    - 队列数据没有积压数据，且性能小于2000/分钟，有数据可以加载，修改定时任务

## 六.退换货

### ★.退货创建

定时任务发送创建退款单数据至MQ，消费队列创建退货单

- 定时任务平台配置： agAutoCreateReturnToMqTaskManager

- 监听队列：CG_toms2toms_ag_return_refund_pro*

- 所属服务治理消费分组：  生产-自动化售后

- 创建退货性能监控

    ```
    SELECT
       DATE_FORMAT(
          t.CREATE_TIME,
          '%Y-%c-%d'
       ) 处理效率,
       COUNT(1)
    FROM
        t_ag_return_details t
    WHERE
       t.CREATE_TIME >= '2020-11-1 00:00:00'
    AND (t.IS_SECOND_CREATE = 1 OR t.IS_THIRD_CREATE = 1)
     GROUP BY
       DATE_FORMAT(
          t.CREATE_TIME,
          '%Y-%c-%d'
       );
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于500/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于500/分钟，调整线程数和副本数

- 代码入口:

    ```
    com.jumbo.taobao.manager.AutoCreateReturnAppByAgCommandManagerImpl#autoCreateReturnApp
    ```

### ★.换货创建

定时任务发送创建退款单数据至MQ，消费队列创建换货单

- 定时任务平台配置： agAutoCreateReturnExchangeTaskManager

- 监听队列：CG_toms2toms_auto_exchange_direct_pro*

- 所属服务治理消费分组：  生产-自动化售后

- 创建换货性能监控

    ```
    SELECT
    	DATE_FORMAT(
    		t.UPDATE_TIME,
    		'%Y-%c-%d %H:%i'
    	) 处理时间,
    	COUNT(1)
    FROM
    	t_td_return_exchange_direct t
    WHERE
    	t.CREATE_TIME >= '2020-11-1 00:30:00'
    AND t.AUTO_CREATE_STATUS = 1
    GROUP BY
    	DATE_FORMAT(
    		t.UPDATE_TIME,
    		'%Y-%c-%d %H:%i'
    	)
    ORDER BY
    	DATE_FORMAT(
    		t.UPDATE_TIME,
    		'%Y-%c-%d %H:%i'
    	);
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于500/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于500/分钟，调整线程数和副本数

- 代码入口:

    ```
    com.jumbo.tmalloms.manager.returns.AutoCreateExchangeByDirectManagerImpl#executeCreate
    ```

    

### ★.换货过路由

#### 1.发送换货数据至IM

定时任务发送【退换货直连WMS任务数据】直接发送至MQ

- 定时任务平台配置： RasRouteManager

- 监听队列：MQ_toms2hub_to_route_so_order_pro(hub消费)

- 换货过路由监控

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') 路由, COUNT(1)
    FROM t_send_wms a
    WHERE a.SHOP_ID NOT IN (
                            5978, 2322, 2362, 2402, 2422, 2462, 2516, 2542, 2582, 221, 5464, 5229, 8332, 8381, 8382, 5627,
                            6277,
                            1063, 1122, 1482, 1622, 1682, 1802, 1882, 1942, 8338, 4582, 1402
        )
      AND a.CREATE_TIME > '2020-11-1 00:00:00'
      AND a.MSG_TYPE = 'RAROUTE'
    GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i')
    ORDER BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') DESC
    ```

- 性能调优方向：

    - 定时任务参数，频率调整

- 性能调优条件

    - 队列数据没有积压数据，且性能小于500/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于500/分钟，调整线程数和副本数


#### 2.处理路由反馈

oms监听hub队列反馈直接回填仓库值

- 监听队列：CG_hub2toms_order_split_result_pro

- 所属服务治理消费分组：生产-路由反馈&过仓反馈&在途反馈&库存同步

- 性能监控

    ```
    SELECT
       DATE_FORMAT(
          t.CREATE_TIME,
          '%Y-%c-%d'
       ) 处理效率,
       COUNT(1)
    FROM
        t_td_return_application_summary t
    WHERE
       t.CREATE_TIME >= '2020-11-1 00:00:00'
      AND t.IS_ORDER_ROUTE = 1
    AND t.IS_GET_OWNER = 1
     GROUP BY
       DATE_FORMAT(
          t.CREATE_TIME,
          '%Y-%c-%d'
       );
    ```

- 性能调优方向：

    - 调整消费线程数量和副本数量

- 性能调优条件

    - 所有队列数据都有积压，且性能小于500/分钟，调整线程数和副本数




### ★.退换货过仓

TOMS退货过仓发送塔内队列，进行过仓消费

- 定时任务平台配置： returnOrderTransferToWmsNewManager

- 监听队列：CG_toms2toms_return_to_wh_pro*

- 所属服务治理消费分组：  生产-过仓

- 创建退货性能监控

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') 退货过仓, COUNT(1)
    FROM t_send_wms a
    WHERE a.SHOP_ID NOT IN (
                            5978, 2322, 2362, 2402, 2422, 2462, 2516, 2542, 2582, 221, 5464, 5229, 8332, 8381, 8382, 5627,
                            6277,
                            1063, 1122, 1482, 1622, 1682, 1802, 1882, 1942, 8338, 4582, 1402
        )
      AND a.CREATE_TIME > '2020-11-1 00:00:00'
      AND a.MSG_TYPE = 'RA'
    GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i')
    ORDER BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于500/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于500/分钟，调整线程数和副本数

- 代码入口

    ```
    com.jumbo.tmalloms.manager.huboms.ReceiveRocketMqMsgManagerImpl#receiveRocketMqReturnToWh
    ```

    

### ★.退换货入库

监听mq生产入库数据中间表,定时任务跑退换货入库

- 监听队列：CG_toms2toms_wms_qimen_out_bound_pro

- 所属服务治理消费分组： 生产-路由反馈&过仓反馈&在途反馈&库存同步

- 定时任务平台：wmsOrderStatusByDbManager

- 入库性能脚本：

    ```
    SELECT DATE_FORMAT(t.input_time, '%Y-%c-%d %H:%i') 在途反馈, COUNT(*)
    FROM t_wms_order_status t
    WHERE t.INPUT_TIME > '2020-11-1 00:00:00'
      AND (t.SHOP_ID not IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               ) OR t.SHOP_ID IS NULL)
      AND t.process_status = 10
      and t.ORDER_TYPE = 41
    GROUP BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H:%i')
    ORDER BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H:%i') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于200/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于200/分钟，调整线程数和副本数

- 代码入口：

    ```
    com.jumbo.tmalloms.manager.sales.impl.WmsOrderStatusManagerImpl#convertAndSaveWmsOrderStatus(java.lang.Long, java.lang.String)
    com.jumbo.qimen.manager.QiMenProducerProductManagerImpl#receiveRocketWmsMqMsg
    com.jumbo.tmalloms.manager.sales.impl.WmsOutOrderFeedbackManagerImpl#convertAndSaveWmsOutOrderStatusNew
    ```



### ★.换货过仓

定时任务发送队列消费过仓

- 定时任务平台：handleMiddleManager

- 监听队列：MQ_toms2toms_wms_return_exchange_outbound_pro*

- 所属服务治理消费分组：生产-过仓

- 过仓性能脚本

    ```
    SELECT DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') 换出过仓, COUNT(1)
    FROM t_send_wms a
    WHERE a.SHOP_ID NOT IN (
                            5978, 2322, 2362, 2402, 2422, 2462, 2516, 2542, 2582, 221, 5464, 5229, 8332, 8381, 8382, 5627,
                            6277,
                            1063, 1122, 1482, 1622, 1682, 1802, 1882, 1942, 8338, 4582, 1402
        )
      AND a.CREATE_TIME > '2020-11-1 00:00:00'
      AND a.MSG_TYPE = 'CHANGE_OUT'
    GROUP BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i')
    ORDER BY DATE_FORMAT(a.CREATE_TIME, '%Y-%c-%d %H%i') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于200/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于200/分钟，调整线程数和副本数

- 代码入口：

    ```
    com.jumbo.tmalloms.manager.HandleMiddleManager#orderToInterFace
    ```

### ★.换货在途

监听mq生产在途数据中间表,定时任务跑退换货入库

- 监听队列：CG_toms2toms_wms_qimen_out_bound_pro

- 所属服务治理消费分组： 生产-路由反馈&过仓反馈&在途反馈&库存同步

- 定时任务平台：wmsOrderStatusByDbManager

- 入库性能脚本：

    ```
    SELECT DATE_FORMAT(t.input_time, '%Y-%c-%d %H:%i') 在途反馈, COUNT(*)
    FROM t_wms_order_status t
    WHERE t.INPUT_TIME > '2020-11-1 00:00:00'
      AND (t.SHOP_ID not IN
           (
            11502, 11501, 11499, 176706, 176704, 11498, 11497, 176705, 176703, 11495, 11496, 176701, 176700, 176702, 11500,
            11494, 11493, 326725, 326726, 176707
               ) OR t.SHOP_ID IS NULL)
      AND t.process_status = 10
      and t.ORDER_TYPE = 42
    GROUP BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H:%i')
    ORDER BY DATE_FORMAT(t.INPUT_TIME, '%Y-%c-%d %H:%i') DESC;
    ```

- 性能调优方向：

    - 定时任务参数，频率调整
    - 调整消费线程数量和副本数量

- 性能调优条件

    - 队列数据没有积压数据，且性能小于50/分钟，有数据可以加载，修改定时任务
    - 所有队列数据都有积压，且性能小于50/分钟，调整线程数和副本数

- 代码入口：

    ```
    com.jumbo.tmalloms.manager.sales.impl.WmsOrderStatusManagerImpl#convertAndSaveWmsOrderStatus(java.lang.Long, java.lang.String)
    com.jumbo.qimen.manager.QiMenProducerProductManagerImpl#receiveRocketWmsMqMsg
    com.jumbo.tmalloms.manager.sales.impl.WmsOutOrderFeedbackManagerImpl#convertAndSaveWmsOutOrderStatusNew
    ```



## 七.其他链路



# II.全链路节点查询

## 订单单节点流转监控

```
SELECT COUNT(s.PLATFORM_ORDER_CODE_N)                                count,
       n.`NAME`,
       wh.SYSTEM_CODE,
       CASE WHEN IS_DIRECT_WMS_ORDER = 0 THEN '非直连' ELSE '直连' END AS 'DIRECT',
       s.SPECIAL_TYPE
FROM t_td_sales_order s FORCE INDEX (IDX_CREATE_TIME),
     t_wf_workflow_task t,
     t_wf_workflow_node n,
     t_ma_tb_shop_info info,
     t_ma_shop_wh wh
WHERE s.OMS_ORDER_CODE = t.REF_SLIP_CODE
  AND t.CURRENT_NODE_NO = n.NODE_NO
  AND s.erp_shop_code = info.id
  AND wh.WH_CODE = S.WAREHOUSE_CODE
  AND wh.shop_id = s.erp_shop_code
  AND date_add(t.enter_time, INTERVAL 30 MINUTE) < SYSDATE() -- 超过30分钟
  AND t.enter_time >= '2020-11-1'
  AND s.TB_PAYMENT_TIME >= '2020-11-1'
  AND s.CREATE_TIME >= '2020-11-1'                            -- AND S.PLATFORM_ORDER_CODE_N='635602339135704753'
  AND t.CURRENT_NODE_NO IN (2, 3, 8, 11, 12, 22, 24, 114, 15,19) -- AND t.CURRENT_NODE_NO IN (114) -- 路由反馈
  AND n.WORKFLOW_ID = 1                                       -- AND s.TB_PAYMENT_TIME > DATE_SUB(SYSDATE(),INTERVAL 2 DAY)
GROUP BY n.`NAME`, wh.SYSTEM_CODE, DIRECT, s.SPECIAL_TYPE
ORDER BY count DESC;
```



# III.数据监控查询

## 创单失败查询

根据错误分组查询脚本：

```
SELECT
    a.error_msg dd,
    COUNT(1)
FROM
    t_mq_so_log a
WHERE
    a.CREATE_TIME >= '2020-11-1 00:00:00'
AND a.`status` = 5
GROUP BY
    dd
ORDER BY
    dd DESC;
```



## 过仓失败查询

```
SELECT COUNT(s.PLATFORM_ORDER_CODE_N)                                count,
       n.`NAME`,
       wh.SYSTEM_CODE,
       CASE WHEN IS_DIRECT_WMS_ORDER = 0 THEN '非直连' ELSE '直连' END AS 'DIRECT',
       s.SPECIAL_TYPE
FROM t_td_sales_order s FORCE INDEX (IDX_CREATE_TIME),
     t_wf_workflow_task t,
     t_wf_workflow_node n,
     t_ma_tb_shop_info info,
     t_ma_shop_wh wh
WHERE s.OMS_ORDER_CODE = t.REF_SLIP_CODE
  AND t.CURRENT_NODE_NO = n.NODE_NO
  AND s.erp_shop_code = info.id
  AND wh.WH_CODE = S.WAREHOUSE_CODE
  AND wh.shop_id = s.erp_shop_code
  AND s.TB_PAYMENT_TIME >= '2020-10-26'
  AND s.CREATE_TIME >= '2020-10-26'                            -- AND S.PLATFORM_ORDER_CODE_N='635602339135704753'
  AND t.CURRENT_NODE_NO = 19 -- AND t.CURRENT_NODE_NO IN (114) -- 路由反馈
  AND n.WORKFLOW_ID = 1                                       -- AND s.TB_PAYMENT_TIME > DATE_SUB(SYSDATE(),INTERVAL 2 DAY)
GROUP BY n.`NAME`, wh.SYSTEM_CODE, DIRECT, s.SPECIAL_TYPE
ORDER BY count DESC;

```



## 订单取消情况

#### 订单取消失败及积压情况

```
SELECT
	COUNT(1)
FROM
	t_ag_ship_cancel_detail t
WHERE
	t.`STATUS` != 10
AND t.CREATE_TIME >= '2020-11-1';
```

#### 取消重推脚本

```
UPDATE t_ag_ship_cancel_detail
SET `STATUS` = 0,
 LAST_EXECUTE_TIME = NOW()
WHERE
	CREATE_TIME >= '2020-11-1 00:00:00'
AND `STATUS` NOT IN (10,0);
```

#### 退款指令成功且订单已在途明细

```
SELECT shop.ID                              '店铺id',
       shop.SESSION_KEY                     'sessionKey',
       shop.SHOP_ID                         '店铺名称',
       concat(so.PLATFORM_ORDER_CODE, '')   '平台订单号',
       concat(so.PLATFORM_ORDER_CODE_N, '') 'oms订单号',
       d.REFUND_CODE                        '退款编码',
       d.STATUS                             '平台退款状态',
       so.ORDER_STATUS                      '订单状态',
       so.IS_DIRECT_WMS_ORDER               '仓储系统',
       so.WAREHOUSE_CODE                    '仓库编码',
       delivery.ACTUAL_TRANS_NAME           '物流商',
       delivery.TRANS_NUMBER                '物流单号',
       delivery.ADDRESS                     '地址',
       d.REFUND_FEE                         '退款指令金额',
       l.TOTAL_AMOUNT_AFTER_DISCOUNT        '订单行金额',
       l.QUANTITY                           '订单行数量',
       shop.OPEN_AG_REFUND                  '是否开启自动取消',
       shop.IS_AUTO_APPOINTMENT             '是否hold单',
       shop.APPOINTMENT_TIME                'hold单时间',
       delivery.CONTACT_PERSON              '收件人',
       delivery.RECEIVER_MOBILE             '电话号码'
FROM t_td_refund_direct d,
     t_td_sales_order so,
     t_td_sales_order_line l,
     t_ma_tb_shop_info shop,
     t_td_so_delivery_info delivery
WHERE so.ID = l.SALES_ORDER_ID
  AND so.PLATFORM_ORDER_CODE = d.TID
  AND shop.ID = so.ERP_SHOP_CODE
  AND l.PLATFORM_ORDER_LINE_CODE = d.OID
  AND delivery.SALES_ORDER_ID = so.ID
  AND d.`STATUS` = 'SUCCESS'
  AND d.HAS_GOOD_RETURN = 0
  AND so.ORDER_STATUS = 6
  AND l.TOTAL_AMOUNT_AFTER_DISCOUNT = d.REFUND_FEE
  AND l.ORDER_LINE_TYPE != 5
  AND d.RD_STATUS = 0
  AND so.TB_PAYMENT_TIME >= '2020-10-29'
  AND so.CREATE_TIME >= '2020-10-21';
```



#### 退款指令成功且订单已未在途且未取消作废明细

```
SELECT shop.ID                              '店铺id',
       shop.SESSION_KEY                     'sessionKey',
       shop.SHOP_ID                         '店铺名称',
       concat(so.PLATFORM_ORDER_CODE, '')   '平台订单号',
       concat(so.PLATFORM_ORDER_CODE_N, '') 'oms订单号',
       d.REFUND_CODE                        '退款编码',
       d.STATUS                             '平台退款状态',
       so.ORDER_STATUS                      '订单状态',
       so.IS_DIRECT_WMS_ORDER               '仓储系统',
       so.WAREHOUSE_CODE                    '仓库编码',
       delivery.ACTUAL_TRANS_NAME           '物流商',
       delivery.TRANS_NUMBER                '物流单号',
       delivery.ADDRESS                     '地址',
       d.REFUND_FEE                         '退款指令金额',
       l.TOTAL_AMOUNT_AFTER_DISCOUNT        '订单行金额',
       l.QUANTITY                           '订单行数量',
       shop.OPEN_AG_REFUND                  '是否开启自动取消',
       shop.IS_AUTO_APPOINTMENT             '是否hold单',
       shop.APPOINTMENT_TIME                'hold单时间',
       delivery.CONTACT_PERSON              '收件人',
       delivery.RECEIVER_MOBILE             '电话号码'
FROM t_td_refund_direct d,
     t_td_sales_order so,
     t_td_sales_order_line l,
     t_ma_tb_shop_info shop,
     t_td_so_delivery_info delivery
WHERE so.ID = l.SALES_ORDER_ID
  AND so.PLATFORM_ORDER_CODE = d.TID
  AND shop.ID = so.ERP_SHOP_CODE
  AND l.PLATFORM_ORDER_LINE_CODE = d.OID
  AND delivery.SALES_ORDER_ID = so.ID
  AND d.`STATUS` = 'SUCCESS'
  AND d.HAS_GOOD_RETURN = 0
  AND so.ORDER_STATUS NOT IN (0, 10, 6)
  AND l.TOTAL_AMOUNT_AFTER_DISCOUNT = d.REFUND_FEE
  AND l.ORDER_LINE_TYPE != 5
  AND d.RD_STATUS = 0
  AND so.TB_PAYMENT_TIME >= '2020-10-29'
  AND so.CREATE_TIME >= '2020-10-21';
```



## 同步平台发货失败

```
  SELECT
	ERROR_CODE,ERROR_MESSAGE,COUNT(1)
FROM
	t_send_hub_msg t
WHERE
	t.MSG_TYPE = 'msg-02'
AND t.CREATE_TIME >= '2020-11-1 00:30:00'
AND t.error_code IS NOT NULL
GROUP BY t.ERROR_CODE;
```



## 预包订单刷尾款查询（数据核对）

- 预包过仓是否积压

    ```
    SELECT
            count(1)
    FROM
            t_so_step_wh_queue s
    LEFT JOIN t_td_sales_order t ON t.id = s.SO_ID
    WHERE
            t.IS_DIRECT_WMS_ORDER in(1,3)
    AND s.CREATE_TIME > '2020-11-01'
    AND s.PROCESS_STATUS IN (0, 2);
    ```

    

- by仓储系统统计已刷尾款且通知仓库出库的，wms3，wms4

    ```
    SELECT
        count(1)
    FROM
        t_so_step_wh_queue s
    LEFT JOIN t_td_sales_order t ON t.id = s.SO_ID
    WHERE
        t.IS_DIRECT_WMS_ORDER = 1
    AND s.CREATE_TIME >= '2020-11-01 00:00:00'
    AND s.id > 81903001
    AND s.PROCESS_STATUS = 10
    
    -- IS_DIRECT_WMS_ORDER = 3 wsm4.0
    ```

    每两个小时执行一次

## 4号预售订单尾款指令和取消指令接入情况监控（付尾款结束后）

- 如果根据脚本查询出数据，说明指令未接入，或者订单未取消，需要核实。


```
SELECT` `COUNT``(*) ``from` `t_td_sales_order t ``where` `t.CREATE_TIME > ``'2020-10-21'` `and` `t.SPECIAL_TYPE ``in` `(11,12) ``and` `t.FINANCE_STATUS = 2 ``and``t.ORDER_STATUS ``not` `in` `(10,0);
```

## 

## 取消指令核对

```
SELECT shop_id,count(1) FROM (

SELECT
	SHOP_ID,REFUND_ID
FROM
	t_top_tb_refund t
WHERE
	t.CREATE_TIME >= '2020-11-1'
GROUP BY
	SHOP_ID,REFUND_ID
) temp
 GROUP BY temp.SHOP_ID;
```



QA：

1.退款指令解析慢

2.创建换货慢

3.退款卡toms，待客服确认

4.询问式出库

# 相关地址

- 服务治理平台：http://newpc.baozun.com/
- 塔外MQ平台：http://rcp.baozun.com/
- 塔内MQ平台：http://39.98.7.238:30005/#/
- 定时任务平台：http://39.98.7.238:9001/index
- appolo配置中心：http://apollo.baozunops.com
- 解密平台 http://web01.toms.test.baozun.cn/autoCreate/SingleOrderCreate

# 调整线程步骤

| 执行步骤                                   |      |
| ------------------------------------------ | ---- |
| 登陆服务治理平台：http://newpc.baozun.com/ |      |
| 1，找到消费者组：生产-创单                 |      |
| 2，进入编辑详情页面                        |      |
| 3，调整队列的机器数和线程数                |      |